name: TestAutomation

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron: "40 23 * * *"
  workflow_dispatch: null

jobs:
  HourReportingAutomation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          
      - name: Install dependencies
        run: npm install
        
      - name: Install Playwright browsers
        run: npx playwright install

      - name: Capture Start Time
        id: start_time
        run: echo "START_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        
      - name: Run Playwright tests
        run: npx playwright test
        env:
          CI: true
          REDMINE_USERNAME: ${{ secrets.REDMINE_USERNAME }}
          REDMINE_PASSWORD: ${{ secrets.REDMINE_PASSWORD }}

      - name: Capture End Time and Duration
        id: end_time
        run: |
          END_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          START_TIME="${{ env.START_TIME }}"
          DURATION=$(echo $(date -d "$END_TIME" +%s) - $(date -d "$START_TIME" +%s) | bc)
          echo "END_TIME=$END_TIME" >> $GITHUB_ENV
          echo "DURATION=$DURATION" >> $GITHUB_ENV

      - name: Upload Playwright report
        if: always()  # Siempre se ejecuta, incluso si los tests fallan
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

      # Enviar correo si los tests son exitosos
      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Reporte de Horas: El registro de horas fue Completado Exitosamente"
          to: ${{ secrets.GMAIL_RECIPIENT }}
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            Buenas tardes, John,
  
            Nos complace informarle que su reporte diario en Redmine/Operaciones SQA se ha ejecutado con √©xito.

            ![Captura de pantalla](cid:screenshot)
  
               Resumen del Proceso
            - Plataforma: Redmine/Operaciones SQA
            - Fecha de Ejecuci√≥n: ${{ env.START_TIME }}
            - Hora de Finalizaci√≥n: ${{ env.END_TIME }}
            - Estado General: ‚úÖ Exitoso.
            - Duraci√≥n del Proceso: ${{ env.DURATION }} Segundos
  
                Detalles del Proceso
            - Todos los pasos fueron completados con √©xito.
            - Sin errores ni interrupciones durante la ejecuci√≥n.
            - Reporte Generado: S√≠.
  
                Pr√≥ximos Pasos
            - El reporte est√° disponible para su revisi√≥n detallada.
            - Si necesita realizar alguna acci√≥n adicional o tiene dudas, por favor, no dude en contactarnos.
  
            Gracias por confiar en nuestro servicio, John.  
            Estamos comprometidos en ofrecerle un proceso continuo y eficiente. 
  
            Saludos cordiales,  
            _Equipo de Automatizaci√≥n y Reportes_  

            
            Nota: Este mensaje fue generado autom√°ticamente por nuestro sistema. Si tiene preguntas, no dude en contactarnos.
         ## attachments: playwright-report/index.html  # Aseg√∫rate de que este archivo exista
          attachments: |
                   [
                           { "file": "path/to/screenshot.png", "inline": true, "cid": "screenshot" }
                   ]

      # Enviar correo si los tests fallan
      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üö® Alerta Se Presentaros Fallos : El registro de horas Fallaron Durante la Ejecuci√≥n"
          to: ${{ secrets.GMAIL_RECIPIENT }}
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            Buenas tardes, John,
  
            Queremos informarle que durante la ejecuci√≥n del reporte diario en Redmine/Operaciones SQA, se detectaron problemas que impidieron completar el proceso con √©xito.  
  
                Resumen del Proceso
            - Plataforma: Redmine/Operaciones SQA
            - Fecha de Ejecuci√≥n: ${{ env.START_TIME }}
            - Hora de Finalizaci√≥n: ${{ env.END_TIME }}
            - Estado General: ‚ùå Fallido.
            - Duraci√≥n del Proceso:  ${{ env.DURATION }} Segundos
  
                Detalles del Problema
            - Descripci√≥n del Error: [Mensaje de error espec√≠fico si est√° disponible o ‚ÄúProblema no especificado‚Äù].
            - Paso Afectado: [Paso o m√≥dulo afectado en Redmine/Operaciones SQA].
            - Reporte Generado: S√≠.
  
            Nuestro equipo ya est√° investigando el incidente para identificar la causa ra√≠z y aplicar una soluci√≥n lo m√°s pronto posible.  
  
            Recomendaciones
            - Le sugerimos no realizar acciones manuales en los m√≥dulos afectados hasta que le confirmemos que el problema ha sido resuelto.  
            - Si necesita asistencia inmediata, puede responder este correo o contactarnos directamente.
  
            Agradecemos su comprensi√≥n, John.  
            Lamentamos los inconvenientes ocasionados y seguimos trabajando para restablecer el servicio a la brevedad.
  
            Saludos cordiales,  
            _Equipo de Automatizaci√≥n y Reportes_  
  
            ---
            Nota: Este mensaje fue generado autom√°ticamente por nuestro sistema. Si tiene preguntas, no dude en contactarnos.
  
          attachments: playwright-report/index.html  # Aseg√∫rate de que este archivo exista
